#!/bin/bash
set -e -x

echo "Installing spectrum-scale-driver"
echo "Current dir: $PWD"
ls -alh

GPFS_INSTALL_DIR=$HOME/GPFS_latest
GPFS_BIN_PATH=/usr/lpp/mmfs/bin
GPFS_ROOT_PASSWD=<%= p("spectrum_password") %>
export SSHPASS=$GPFS_ROOT_PASSWD

GPFS_SERVER_HOSTNAME=<%= p("spectrum_server_hostname") %>
GPFS_SERVER_IP=<%= p("spectrum_server_ip") %>

GPFS_CLIENT_HOSTNAME=$HOSTNAME
GPFS_CLIENT_IP=$(hostname -I | cut -f1 -d ' ')

# Install Dependencies
echo "Installing dependencies required for setting up GPFS Client"
apt-get update
apt-get -y install python nfs-common ksh binutils libaio1 m4 gawk alien devscripts sshpass

# Install GPFS Client packages
echo "Installing GPFS Client packages"
cd /var/vcap/packages/spectrum_plugin
dpkg -i gpfs.base*deb gpfs.gpl*deb gpfs.gskit*deb gpfs.msg*deb gpfs.ext*deb gpfs.adv*deb gpfs.crypto*deb gpfs.docs*deb

# Add GPFS bin directory to PATH
echo "Setting GPFS bin path"
export PATH=$PATH:$GPFS_BIN_PATH

# Build GPFS Kernel modules
echo "Building GPFS Kernel Modules"
mmbuildgpl

# Add GPFS client and server IP details to hosts file on the GPFS client
echo " Updating /etc/hosts file on the GPFS client"
echo "$GPFS_CLIENT_IP $GPFS_CLIENT_HOSTNAME" >> /etc/hosts
echo "$GPFS_SERVER_IP $GPFS_SERVER_HOSTNAME" >> /etc/hosts

# Add GPFS client and server IP details to hosts file on the GPFS server
echo "Updating /etc/hosts file on the GPFS Server"
sshpass -e ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no sed -i -- "/^${GPFS_CLIENT_IP}/d" /etc/hosts


cmd1="echo \"$GPFS_CLIENT_IP $GPFS_CLIENT_HOSTNAME\" >> /etc/hosts"
sshpass -e ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $cmd1

#cmd2="echo \"$GPFS_SERVER_IP $GPFS_SERVER_HOSTNAME\" >> /etc/hosts"
#sshpass -e ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $cmd2

# Generate ssh keys
echo "Generating SSH keys"
ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa

# Enable passwordless ssh between GPFS client cell and the GPFS server
echo "Enabling passwordless ssh between GPFS client cell and server"
eval `ssh-agent`
ssh-add ~/.ssh/id_rsa
echo "Home: $HOME"
export HOME=/root

sshpass -e ssh-copy-id root@$GPFS_SERVER_HOSTNAME


# enable root ssh
echo -e "gpfsr0x\ngpfsr0x" | passwd
# update sshd.conf
sed -i -- 's/PermitRootLogin no/PermitRootLogin yes/g' /etc/ssh/sshd_config
sed -i -- 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
# restart ssh
service ssh restart


cmd3="sshpass -p $SSHPASS ssh-copy-id -o StrictHostKeyChecking=no root@$GPFS_CLIENT_HOSTNAME"
ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $cmd3

# Configuring Cell as GPFS Client
echo "Configuring Cell as GPFS Client"
mmCmd1="/usr/lpp/mmfs/bin/mmaddnode -N $GPFS_CLIENT_HOSTNAME"
ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $mmCmd1

mmCmd2="/usr/lpp/mmfs/bin/mmchlicense client --accept -N $GPFS_CLIENT_HOSTNAME"
ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $mmCmd2

mmCmd3="/usr/lpp/mmfs/bin/mmstartup -N $GPFS_CLIENT_HOSTNAME"
ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $mmCmd3

sleep 15s

mmCmd5="/usr/lpp/mmfs/bin/mmmount all -N $GPFS_CLIENT_HOSTNAME"
ssh root@$GPFS_SERVER_HOSTNAME -o StrictHostKeyChecking=no $mmCmd5

echo "Successfully configured cell $HOSTNAME as GPFS Client for Server $GPFS_SERVER_HOSTNAME"






echo "Installed spectrum-scale-driver"
exit 0
